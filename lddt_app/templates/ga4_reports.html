<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>GA4 Dashboard</title>

    <!-- Libraries -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: Arial, sans-serif; padding: 30px; background: #f9fafc; }
        h2 { text-align: center; }
        table { width: 95%; margin: 20px auto; border-collapse: collapse; background: #fff; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background: #007bff; color: #fff; }
        tr:nth-child(even) { background: #f2f2f2; }
        .btn { padding: 10px 18px; border-radius: 8px; font-weight: bold; color: #fff; cursor: pointer; border: none; }
        .btn-refresh { background: #007bff; }
        .btn-export { background: #28a745; }
        .button-bar { width: 95%; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .chart-container { width: 95%; margin: auto; }
        .status { text-align: center; color: #007bff; }
    </style>
</head>
<body>
<h2>Google Analytics Dashboard</h2>

<div class="button-bar">
    <button class="btn btn-refresh" id="refreshBtn">üîÑ Refresh Data</button>
    <a href="?export=excel" class="btn btn-export">‚¨áÔ∏è Export to Excel</a>
</div>

<!-- ‚úÖ show cached status -->
<p class="status" id="status">
    {% if last_updated %}
        Last updated: {{ last_updated }}
    {% else %}
        No data yet ‚Äî click "üîÑ Refresh Data" to load the dashboard.
    {% endif %}
</p>

<!-- ‚úÖ main data table -->
<table id="mainTable">
    <thead>
        <tr>
            <th>Service</th>
            <th>Connection</th>
            <th>Receiving</th>
            <th>Trend</th>
            <th>Active (30m)</th>
            <th>30 Days</th>
            <th>6 Months</th>
            <th>1 Year</th>
            <th>First Data</th>
        </tr>
    </thead>
    <tbody>
        {% if dashboard_data %}
            {% for r in dashboard_data %}
            <tr>
                <td>{{ r.property_name }}</td>
                <td>{{ r.connection_status }}</td>
                <td>{{ r.receiving_status }}</td>
                <td>{{ r.trend }}</td>
                <td>{{ r.active_30min }}</td>
                <td>{{ r.visits_30days }}</td>
                <td>{{ r.visits_6months }}</td>
                <td>{{ r.visits_year }}</td>
                <td>{{ r.first_recorded_date }}</td>
            </tr>
            {% endfor %}
        {% endif %}
    </tbody>
</table>

<h2>Monthly Visits (Last 12 Months)</h2>
<table id="monthlyTable">
    <thead>
        <tr id="monthHeader">
            <th>Service</th>
            {% if months_list %}
                {% for m in months_list %}
                    <th>{{ m }}</th>
                {% endfor %}
            {% endif %}
        </tr>
    </thead>
    <tbody>
        {% if monthly_dashboard %}
            {% for r in monthly_dashboard %}
                <tr>
                    <td>{{ r.property_name }}</td>
                    {% for v in r.monthly_visits %}
                        <td>{{ v }}</td>
                    {% endfor %}
                </tr>
            {% endfor %}
        {% endif %}
    </tbody>
</table>

<div class="chart-container">
    <canvas id="monthlyChart"></canvas>
</div>

<script>
let chart = null;

function renderChart(months, monthlyData) {
    if (chart) chart.destroy();
    if (!months || !monthlyData) return;
    const ctx = document.getElementById("monthlyChart").getContext("2d");
    const datasets = monthlyData.map((p, i) => ({
        label: p.property_name,
        data: p.monthly_visits,
        borderColor: `hsl(${i * 35}, 70%, 50%)`,
        fill: false,
        tension: 0.3
    }));
    chart = new Chart(ctx, {
        type: "line",
        data: { labels: months, datasets },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });
}

document.addEventListener("DOMContentLoaded", function() {
    // ‚úÖ initialize tables with any cached data
    $("#mainTable").DataTable();
    $("#monthlyTable").DataTable();

    // ‚úÖ render cached chart if data available
    const cachedMonths = {{ months_list|safe|default:"[]" }};
    const cachedMonthly = {{ monthly_dashboard|safe|default:"[]" }};
    if (cachedMonths.length && cachedMonthly.length) {
        renderChart(cachedMonths, cachedMonthly);
    }
});

document.getElementById("refreshBtn").addEventListener("click", function() {
    const btn = this;
    btn.disabled = true;
    btn.innerText = "‚è≥ Fetching...";
    $("#status").text("Fetching GA4 data...");

    fetch("{% url 'ga4_report' %}", { headers: { "X-Requested-With": "XMLHttpRequest" } })
        .then(r => {
            if (!r.ok) throw new Error("Server error: " + r.status);
            return r.json();
        })
        .then(json => {
            const dashboard = json.dashboard;
            const monthly = json.monthly;
            const months = json.months;

            // --- Fill main table ---
            const tbody = $("#mainTable").DataTable().clear();
            dashboard.forEach(r => {
                tbody.row.add([
                    r.property_name,
                    r.connection_status,
                    r.receiving_status,
                    r.trend,
                    r.active_30min,
                    r.visits_30days,
                    r.visits_6months,
                    r.visits_year,
                    r.first_recorded_date
                ]);
            });
            tbody.draw();

            // --- Fill monthly table ---
            const monthHead = $("#monthHeader").empty().append("<th>Service</th>");
            months.forEach(m => monthHead.append(`<th>${m}</th>`));

            const mTable = $("#monthlyTable").DataTable().clear();
            monthly.forEach(r => {
                const row = [r.property_name, ...r.monthly_visits];
                mTable.row.add(row);
            });
            mTable.draw();

            renderChart(months, monthly);
            $("#status").text("Last updated: " + new Date(json.last_updated).toLocaleString());
        })
        .catch(err => {
            console.error("Error:", err);
            $("#status").text("‚ö†Ô∏è Error fetching GA4 data. Check console/logs.");
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerText = "üîÑ Refresh Data";
        });
});
</script>
</body>
</html>



