<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>GA4 Dashboard</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'table_style.css' %}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 30px; background: #f9fafc; }
        h2 { text-align: center; }
        table { width: 95%; margin: 20px auto; border-collapse: collapse; background: #fff; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background: #007bff; color: #fff; }
        tr:nth-child(even) { background: #f2f2f2; }
        .btn { padding: 10px 18px; border-radius: 8px; font-weight: bold; color: #fff; cursor: pointer; border: none; }
        .btn-refresh { background: #007bff; }
        .btn-export { background: #28a745; }
        .button-bar { width: 95%; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .chart-container { width: 95%; margin: auto; }
        .status { text-align: center; color: #007bff; margin-top: 10px; }
    </style>
</head>
<body>

<h2>Google Analytics Dashboard</h2>

<div class="button-bar">
    <button class="btn btn-refresh" id="refreshBtn">üîÑ Refresh Data</button>
    <button id="exportExcelBtn" class="btn btn-export">‚¨áÔ∏è Export to Excel</button>
</div>

<p class="status" id="status">
    {% if last_updated %}
        Last updated: {{ last_updated }}
    {% else %}
        No data yet ‚Äî click "üîÑ Refresh Data" to load the dashboard.
    {% endif %}
</p>

<table id="mainTable" class="display">
    <thead>
        <tr>
            <th>Service</th>
            <th>Connection</th>
            <th>Receiving</th>
            <th>Trend</th>
            <th>Active (30m)</th>
            <th>30 Days</th>
            <th>6 Months</th>
            <th>1 Year</th>
            <th>First Data</th>
        </tr>
    </thead>
    <tbody>
        {% for r in dashboard_data %}
        <tr>
            <td>{{ r.property_name }}</td>
            <td>{{ r.connection_status }}</td>
            <td>{{ r.receiving_status }}</td>
            <td>{{ r.trend }}</td>
            <td>{{ r.active_30min }}</td>
            <td>{{ r.visits_30days }}</td>
            <td>{{ r.visits_6months }}</td>
            <td>{{ r.visits_year }}</td>
            <td>{{ r.first_recorded_date }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<h2>Monthly Visits (Last 12 Months)</h2>
<table id="monthlyTable" class="display">
    <thead>
        <tr id="monthHeader">
            <th>Service</th>
            {% for m in months_list %}
                <th>{{ m }}</th>
            {% endfor %}
        </tr>
    </thead>
    <tbody>
        {% for r in monthly_dashboard %}
            <tr>
                <td>{{ r.property_name }}</td>
                {% for v in r.monthly_visits %}
                    <td>{{ v }}</td>
                {% endfor %}
            </tr>
        {% endfor %}
    </tbody>
</table>

<div class="chart-container">
    <canvas id="monthlyChart"></canvas>
</div>

<script>
let chart = null;

function renderChart(months, monthlyData) {
    if (chart) chart.destroy();
    if (!months || !monthlyData) return;
    const ctx = document.getElementById("monthlyChart").getContext("2d");
    const datasets = monthlyData.map((p, i) => ({
        label: p.property_name,
        data: p.monthly_visits,
        borderColor: `hsl(${i * 35}, 70%, 50%)`,
        fill: false,
        tension: 0.3
    }));
    chart = new Chart(ctx, {
        type: "line",
        data: { labels: months, datasets },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });
}

document.addEventListener("DOMContentLoaded", function() {
    $("#mainTable").DataTable();
    $("#monthlyTable").DataTable();
    const cachedMonths = {{ months_list|safe|default:"[]" }};
    const cachedMonthly = {{ monthly_dashboard|safe|default:"[]" }};
    if (cachedMonths.length && cachedMonthly.length) renderChart(cachedMonths, cachedMonthly);
});

document.getElementById("refreshBtn").addEventListener("click", function() {
    const btn = this;
    btn.disabled = true;
    btn.innerText = "‚è≥ Fetching...";
    $("#status").text("Fetching GA4 data...");

    fetch("{% url 'ga4_report' %}", {
        headers: { "X-Requested-With": "XMLHttpRequest" },
        cache: "no-store"
    })
    .then(r => {
        if (!r.ok) throw new Error("Server error: " + r.status);
        return r.json();
    })
    .then(json => {
        console.log("GA4 response:", json);
        const { dashboard, monthly, months, last_updated } = json;

        // --- Reset main table ---
        if ($.fn.DataTable.isDataTable("#mainTable")) {
            $("#mainTable").DataTable().clear().destroy();
        }
        const mainTable = $("#mainTable").DataTable();
        dashboard.forEach(r => {
            mainTable.row.add([
                r.property_name,
                r.connection_status,
                r.receiving_status,
                r.trend,
                r.active_30min,
                r.visits_30days,
                r.visits_6months,
                r.visits_year,
                r.first_recorded_date
            ]);
        });
        mainTable.draw();

        // --- Reset monthly table ---
        if ($.fn.DataTable.isDataTable("#monthlyTable")) {
            $("#monthlyTable").DataTable().clear().destroy();
        }
        const monthHead = $("#monthHeader").empty().append("<th>Service</th>");
        months.forEach(m => monthHead.append(`<th>${m}</th>`));

        const monthlyTable = $("#monthlyTable").DataTable();
        monthly.forEach(r => {
            monthlyTable.row.add([r.property_name, ...r.monthly_visits]);
        });
        monthlyTable.draw();

        renderChart(months, monthly);
        $("#status").text("Last updated: " + new Date(last_updated).toLocaleString());
    })
    .catch(err => {
        console.error("Error:", err);
        $("#status").text("‚ö†Ô∏è Error fetching GA4 data. Check console/logs.");
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerText = "üîÑ Refresh Data";
    });
});
    document.getElementById("refreshBtn").addEventListener("click", function() {
    const btn = this;
    console.log("üîÑ Refresh button clicked ‚Äî fetching GA4 data...");
    btn.disabled = true;
    btn.innerText = "‚è≥ Fetching...";
    $("#status").text("Fetching GA4 data...");

    fetch("{% url 'ga4_report' %}", {
        headers: { "X-Requested-With": "XMLHttpRequest" },
        cache: "no-store"
    })
    .then(r => r.json())
    .then(json => {
        console.log("‚úÖ Received GA4 JSON:", json);

        const dashboard = json.dashboard || [];
        const monthly = json.monthly || [];
        const months = json.months || [];

        // Update top table
        if ($.fn.DataTable.isDataTable("#mainTable")) {
            $("#mainTable").DataTable().clear().destroy();
        }
        const mainTable = $("#mainTable").DataTable();
        dashboard.forEach(r => {
            mainTable.row.add([
                r.property_name,
                r.connection_status,
                r.receiving_status,
                r.trend,
                r.active_30min,
                r.visits_30days,
                r.visits_6months,
                r.visits_year,
                r.first_recorded_date
            ]);
        });
        mainTable.draw();

        console.log(`üßæ Inserted ${dashboard.length} rows into main table.`);

        // Update monthly table
        if ($.fn.DataTable.isDataTable("#monthlyTable")) {
            $("#monthlyTable").DataTable().clear().destroy();
        }
        const monthHead = $("#monthHeader").empty().append("<th>Service</th>");
        months.forEach(m => monthHead.append(`<th>${m}</th>`));
        const monthlyTable = $("#monthlyTable").DataTable();
        monthly.forEach(r => {
            const row = [r.property_name, ...r.monthly_visits];
            monthlyTable.row.add(row);
        });
        monthlyTable.draw();

        $("#status").text(`‚úÖ Updated at ${json.last_updated}`);
    })
    .catch(err => {
        console.error("‚ùå Refresh failed:", err);
        $("#status").text("‚ö†Ô∏è Refresh failed, check console.");
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerText = "üîÑ Refresh Data";
    });
});
    document.getElementById("exportExcelBtn").addEventListener("click", function() {
    const btn = this;
    btn.disabled = true;
    btn.innerText = "üì§ Preparing...";

    // ‚úÖ Convert Chart.js canvas to base64 image
    let chartImage = null;
    try {
        const canvas = document.getElementById("monthlyChart");
        chartImage = canvas.toDataURL("image/png");
    } catch (err) {
        console.warn("Chart image not available:", err);
    }

    fetch("{% url 'ga4_report' %}?export=excel", {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/json"
        },
        body: JSON.stringify({ chart_image: chartImage })
    })
    .then(response => {
        if (!response.ok) throw new Error("Failed to export");
        return response.blob();
    })
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "GA4_Report.xlsx";
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);
    })
    .catch(err => {
        console.error("Export failed:", err);
        alert("‚ùå Export failed. Check console.");
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerText = "‚¨áÔ∏è Export to Excel";
    });
});
</script>
</body>
</html>



