<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>GA4 Dashboard</title>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<style>
body { font-family: Arial, sans-serif; padding: 30px; background-color: #f9fafc; }
h2 { text-align: center; margin-bottom: 20px; }
table { width: 90%; margin: auto; border-collapse: collapse; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
th, td { border: 1px solid #ddd; text-align: center; padding: 10px; }
th { background-color: #007bff; color: white; }
tr:nth-child(even){ background-color:#f2f2f2; }
.refreshing{ color:#007bff; font-style:italic; text-align:center; }
.btn{ display:inline-flex; align-items:center; gap:8px; padding:10px 18px; border-radius:8px; font-weight:600; text-decoration:none; transition:all 0.3s ease; cursor:pointer; }
.btn-export{ background:linear-gradient(90deg,#28a745,#218838); color:white; }
.btn-export:hover{ background:linear-gradient(90deg,#218838,#1e7e34); }
.btn-refresh{ background:linear-gradient(90deg,#007bff,#0056b3); color:white; }
.btn-refresh:hover{ background:linear-gradient(90deg,#0056b3,#004085); }
.button-bar{ width:90%; margin:0 auto 20px; display:flex; justify-content:space-between; align-items:center; }
.chart-container{ width:95%; margin:auto; }
select { padding:6px; font-size:1em; }
</style>
</head>
<body>
<h2>Google Analytics Dashboard</h2>
<p class="refreshing" id="status">Last updated just now</p>

<div class="button-bar">
    <button class="btn btn-refresh" id="refreshBtn">ðŸ”„ Refresh Data</button>
    <form id="exportForm" action="{% url 'ga4_report' %}?export=excel" method="POST">
        {% csrf_token %}
        <input type="hidden" name="chart_image" id="chartImageInput">
        <button type="submit" class="btn btn-export">ðŸ“Š Export to Excel</button>
    </form>
</div>

<table id="ga-table">
<thead>
<tr>
<th>Service Name</th><th>Connection Status</th><th>Receiving Status</th><th>Trend</th>
<th>Active Users (Last 30 Min)</th><th>Visits (Last 30 Days)</th>
<th>Visits (Last 6 Months)</th><th>Visits (Last Year)</th><th>First Recorded Data</th>
</tr>
</thead>
<tbody>
{% for row in dashboard_data %}
<tr>
<td>{{ row.property_name }}</td><td>{{ row.connection_status }}</td><td>{{ row.receiving_status }}</td>
<td>{{ row.trend }}</td><td>{{ row.active_30min }}</td><td>{{ row.visits_30days }}</td>
<td>{{ row.visits_6months }}</td><td>{{ row.visits_year }}</td><td>{{ row.first_recorded_date }}</td>
</tr>
{% endfor %}
</tbody>
</table>

<br><br>
<h2>Monthly Stats (Last 12 Months)</h2>
<table id="monthly-table">
<thead>
<tr><th>Service Name</th>{% for m in months_list %}<th>{{ m }}</th>{% endfor %}</tr>
</thead>
<tbody>
{% for row in monthly_dashboard %}
<tr>
<td>{{ row.property_name }}</td>
{% for val in row.monthly_visits %}<td>{{ val }}</td>{% endfor %}
</tr>
{% endfor %}
</tbody>
</table>

<h2>Monthly Visits Chart</h2>
<div class="chart-container">
<select id="propertySelect">
<option value="all" selected>Show All Properties</option>
{% for row in monthly_dashboard %}
<option value="{{ row.property_name }}">{{ row.property_name }}</option>
{% endfor %}
</select>
<canvas id="monthlyChart" style="width:100%; height:500px;"></canvas>
</div>

<script>
const ctx = document.getElementById('monthlyChart');
const months = {{ months_list|safe }};
const allData = {{ monthly_dashboard|safe }};

let chart;
function renderChart(filter = "all") {
    const datasets = allData.filter(p => filter === "all" || p.property_name === filter)
        .map((p,i)=>({
            label: p.property_name,
            data: p.monthly_visits,
            borderColor: `hsl(${i*45},70%,50%)`,
            fill:false,
            tension:0.3
        }));

    if(chart) chart.destroy();

    chart = new Chart(ctx,{
        type:'line',
        data:{ labels:months, datasets },
        options:{
            responsive:true,
            plugins:{
                legend:{ position:'top' },
                title:{ display:true, text:'Monthly Visits per Property' },
                datalabels:{
                    align:'end', anchor:'end', font:{size:9},
                    formatter:(v)=>v, color:'black'
                }
            },
            scales:{ y:{ beginAtZero:true, title:{display:true, text:'Visits'} } }
        },
        plugins:[ChartDataLabels]
    });
}

document.getElementById("propertySelect").addEventListener("change",e=>{
    renderChart(e.target.value);
});

renderChart();

// Export chart image before submitting
document.getElementById("exportForm").addEventListener("submit", function(){
    const imgBase64 = chart.toBase64Image();
    document.getElementById("chartImageInput").value = imgBase64;
});

$('#ga-table, #monthly-table').DataTable();
</script>
</body>
</html>